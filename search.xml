<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>Protect Asterisk 13 with Fail2ban on Ubuntu 16.04</title>
      <link href="/2018/04/08/Protect-Asterisk-13-with-Fail2ban-on-Ubuntu-16-04/"/>
      <url>/2018/04/08/Protect-Asterisk-13-with-Fail2ban-on-Ubuntu-16-04/</url>
      <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>When trying to set up Fail2ban with Asterisk, the Asterisk jail file that comes with your installed Fail2ban version may not always be compatible with your Asterisk version and you may face issues such as attacks not getting blocked or error messages like:</p><figure class="highlight vhdl"><table><tr><td class="code"><pre><span class="line"><span class="number">2018</span>-<span class="number">04</span>-<span class="number">08</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">26</span>,<span class="number">494</span> fail2ban.filter         [<span class="number">10340</span>]: <span class="literal">ERROR</span>   No <span class="symbol">'host</span>' <span class="keyword">group</span> <span class="keyword">in</span> <span class="symbol">'SECURITY</span>.* SecurityEvent=<span class="string">"FailedACL"</span>.*RemoteAddress=<span class="string">".+?/.+?//.+?"</span>.*'</span><br><span class="line"><span class="number">2018</span>-<span class="number">04</span>-<span class="number">08</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">26</span>,<span class="number">494</span> fail2ban.transmitter    [<span class="number">10340</span>]: <span class="literal">WARNING</span> Command [<span class="symbol">'set</span>', <span class="symbol">'asterisk</span>', <span class="symbol">'addfailregex</span>', <span class="symbol">'SECURITY</span>.* SecurityEvent=<span class="string">"FailedACL"</span>.*RemoteAddress=<span class="string">".+?/.+?//.+?"</span>.*'] has failed. Received RegexException(<span class="symbol">'No</span> \<span class="symbol">'host\'</span> <span class="keyword">group</span> <span class="keyword">in</span> \<span class="symbol">'SECURITY</span>.* SecurityEvent=<span class="string">"FailedACL"</span>.*RemoteAddress=<span class="string">".+?/.+?//.+?"</span>.*\'',)</span><br><span class="line"><span class="number">2018</span>-<span class="number">04</span>-<span class="number">08</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">26</span>,<span class="number">496</span> fail2ban.filter         [<span class="number">10340</span>]: <span class="literal">ERROR</span>   No <span class="symbol">'host</span>' <span class="keyword">group</span> <span class="keyword">in</span> <span class="symbol">'SECURITY</span>.* SecurityEvent=<span class="string">"InvalidAccountID"</span>.*RemoteAddress=<span class="string">".+?/.+?//.+?"</span>.*'</span><br><span class="line"><span class="number">2018</span>-<span class="number">04</span>-<span class="number">08</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">26</span>,<span class="number">497</span> fail2ban.transmitter    [<span class="number">10340</span>]: <span class="literal">WARNING</span> Command [<span class="symbol">'set</span>', <span class="symbol">'asterisk</span>', <span class="symbol">'addfailregex</span>', <span class="symbol">'SECURITY</span>.* SecurityEvent=<span class="string">"InvalidAccountID"</span>.*RemoteAddress=<span class="string">".+?/.+?//.+?"</span>.*'] has failed. Received RegexException(<span class="symbol">'No</span> \<span class="symbol">'host\'</span> <span class="keyword">group</span> <span class="keyword">in</span> \<span class="symbol">'SECURITY</span>.* SecurityEvent=<span class="string">"InvalidAccountID"</span>.*RemoteAddress=<span class="string">".+?/.+?//.+?"</span>.*\'',)</span><br><span class="line"><span class="number">2018</span>-<span class="number">04</span>-<span class="number">08</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">26</span>,<span class="number">497</span> fail2ban.filter         [<span class="number">10340</span>]: <span class="literal">ERROR</span>   No <span class="symbol">'host</span>' <span class="keyword">group</span> <span class="keyword">in</span> <span class="symbol">'SECURITY</span>.* SecurityEvent=<span class="string">"ChallengeResponseFailed"</span>.*RemoteAddress=<span class="string">".+?/.+?//.+?"</span>.*'</span><br><span class="line"><span class="number">2018</span>-<span class="number">04</span>-<span class="number">08</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">26</span>,<span class="number">498</span> fail2ban.transmitter    [<span class="number">10340</span>]: <span class="literal">WARNING</span> Command [<span class="symbol">'set</span>', <span class="symbol">'asterisk</span>', <span class="symbol">'addfailregex</span>', <span class="symbol">'SECURITY</span>.* SecurityEvent=<span class="string">"ChallengeResponseFailed"</span>.*RemoteAddress=<span class="string">".+?/.+?//.+?"</span>.*'] has failed. Received RegexException(<span class="symbol">'No</span> \<span class="symbol">'host\'</span> <span class="keyword">group</span> <span class="keyword">in</span> \<span class="symbol">'SECURITY</span>.* SecurityEvent=<span class="string">"ChallengeResponseFailed"</span>.*RemoteAddress=<span class="string">".+?/.+?//.+?"</span>.*\'',)</span><br><span class="line"><span class="number">2018</span>-<span class="number">04</span>-<span class="number">08</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">26</span>,<span class="number">499</span> fail2ban.filter         [<span class="number">10340</span>]: <span class="literal">ERROR</span>   No <span class="symbol">'host</span>' <span class="keyword">group</span> <span class="keyword">in</span> <span class="symbol">'SECURITY</span>.* SecurityEvent=<span class="string">"InvalidPassword"</span>.*RemoteAddress=<span class="string">".+?/.+?//.+?"</span>.*'</span><br><span class="line"><span class="number">2018</span>-<span class="number">04</span>-<span class="number">08</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">26</span>,<span class="number">499</span> fail2ban.transmitter    [<span class="number">10340</span>]: <span class="literal">WARNING</span> Command [<span class="symbol">'set</span>', <span class="symbol">'asterisk</span>', <span class="symbol">'addfailregex</span>', <span class="symbol">'SECURITY</span>.* SecurityEvent=<span class="string">"InvalidPassword"</span>.*RemoteAddress=<span class="string">".+?/.+?//.+?"</span>.*'] has failed. Received RegexException(<span class="symbol">'No</span> \<span class="symbol">'host\'</span> <span class="keyword">group</span> <span class="keyword">in</span> \<span class="symbol">'SECURITY</span>.* SecurityEvent=<span class="string">"InvalidPassword"</span>.*RemoteAddress=<span class="string">".+?/.+?//.+?"</span>.*\'',)</span><br></pre></td></tr></table></figure><p>I will share a working configuration tested with: </p><ul><li>Ubuntu 16.04</li><li>Asterisk 13.19.0</li><li>Fail2Ban 0.9.3</li></ul><h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><p><strong><code>/etc/fail2ban/filter.d/asterisk.conf</code>:</strong></p><figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Fail2Ban filter for asterisk authentication failures</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">[INCLUDES]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Read common prefixes. If any customizations available -- read them from</span></span><br><span class="line"><span class="comment"># common.local</span></span><br><span class="line">before = common.conf</span><br><span class="line"></span><br><span class="line">[Definition]</span><br><span class="line"></span><br><span class="line">_daemon = asterisk</span><br><span class="line"></span><br><span class="line">__pid_re = (?:<span class="string">\s*\[\d+\])</span></span><br><span class="line"></span><br><span class="line">iso8601 = <span class="string">\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;T\d&#123;2&#125;:\d&#123;2&#125;:\d&#123;2&#125;\.\d+[+-]\d&#123;4&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># All Asterisk log messages begin like this:</span></span><br><span class="line">log_prefix= (?:NOTICE|SECURITY|WARNING)%(__pid_re)s:?(?:<span class="string">\[C-[\da-f]*\])?:?</span> [^:]+:<span class="string">\d*(?:(?:</span> <span class="keyword">in</span>)? [^:]+:)?</span><br><span class="line"></span><br><span class="line">prefregex = ^%(__prefix_line)s%(log_prefix)s &lt;F-CONTENT&gt;.+&lt;/F-CONTENT&gt;$</span><br><span class="line"></span><br><span class="line">failregex = ^Registration <span class="keyword">from</span> <span class="string">'[^'</span>]*<span class="string">' failed for '</span>&lt;HOST&gt;(:<span class="string">\d+)?'</span> - (?:Wrong password|Username/auth name mismatch|No matching peer found|Not a local domain|Device does <span class="keyword">not</span> match ACL|Peer <span class="keyword">is</span> <span class="keyword">not</span> supposed <span class="keyword">to</span> register|ACL error <span class="string">\(permit/deny\)|Not</span> a local domain)$</span><br><span class="line">            ^Call <span class="keyword">from</span> <span class="string">'[^'</span>]*<span class="string">' \(&lt;HOST&gt;:\d+\) to extension '</span>[^<span class="string">']*'</span> rejected because extension <span class="keyword">not</span> found <span class="keyword">in</span> context</span><br><span class="line">            ^(?:Host )?&lt;HOST&gt; (?:failed (?:<span class="keyword">to</span> authenticate<span class="string">\b|MD5</span> authentication<span class="string">\b)|tried</span> <span class="keyword">to</span> authenticate <span class="keyword">with</span> nonexistent user<span class="string">\b)</span></span><br><span class="line">            ^No registration <span class="keyword">for</span> peer <span class="string">'[^'</span>]*<span class="string">' \(from &lt;HOST&gt;\)$</span></span><br><span class="line"><span class="string">            ^hacking attempt detected '</span>&lt;HOST&gt;<span class="string">'$</span></span><br><span class="line"><span class="string">            ^SecurityEvent="(?:FailedACL|InvalidAccountID|ChallengeResponseFailed|InvalidPassword)"(?:(?:,(?!RemoteAddress=)\w+="[^"]*")*|.*?),RemoteAddress="IPV[46]/(UDP|TCP|WS)/&lt;HOST&gt;/\d+"(?:,(?!RemoteAddress=)\w+="[^"]*")*$</span></span><br><span class="line"><span class="string">            ^"Rejecting unknown SIP connection from &lt;HOST&gt;"$</span></span><br><span class="line"><span class="string">            ^Request (?:'</span>[^<span class="string">']*'</span> )?<span class="keyword">from</span> <span class="string">'(?:[^'</span>]*|.*?)<span class="string">' failed for '</span>&lt;HOST&gt;(?::<span class="string">\d+)?'\s\(callid:</span> [^<span class="string">\)]*\)</span> - (?:No matching endpoint found|Not match Endpoint(?: Contact)? ACL|(?:Failed|Error) <span class="keyword">to</span> authenticate)<span class="string">\s*$</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># FreePBX (<span class="doctag">todo:</span> make optional in v.0.10):</span></span><br><span class="line"><span class="comment">#            ^(%(__prefix_line)s|\[\]\s*WARNING%(__pid_re)s:?(?:\[C-[\da-f]*\])? )[^:]+: Friendly Scanner from &lt;HOST&gt;$</span></span><br><span class="line"></span><br><span class="line">ignoreregex =</span><br><span class="line"></span><br><span class="line">datepattern = &#123;^LN-BEG&#125;</span><br></pre></td></tr></table></figure><p><strong><code>/etc/fail2ban/jail.local</code>:</strong></p><p>In the <code>jail.local</code> file, you have to uncomment or add the following asterisk jail:</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">[asterisk]</span><br><span class="line">enabled  = <span class="literal">true</span></span><br><span class="line">port     = 5060,5061</span><br><span class="line">action   = %(banaction)s[<span class="attribute">name</span>=%(__name__)s-tcp, <span class="attribute">port</span>=<span class="string">"%(port)s"</span>, <span class="attribute">protocol</span>=<span class="string">"tcp"</span>, <span class="attribute">chain</span>=<span class="string">"%(chain)s"</span>, <span class="attribute">actname</span>=%(banaction)s-tcp]</span><br><span class="line">           %(banaction)s[<span class="attribute">name</span>=%(__name__)s-udp, <span class="attribute">port</span>=<span class="string">"%(port)s"</span>, <span class="attribute">protocol</span>=<span class="string">"udp"</span>, <span class="attribute">chain</span>=<span class="string">"%(chain)s"</span>, <span class="attribute">actname</span>=%(banaction)s-udp]</span><br><span class="line">           %(mta)s-whois[<span class="attribute">name</span>=%(__name__)s, <span class="attribute">dest</span>=<span class="string">"%(destemail)s"</span>]</span><br><span class="line">logpath  = /var/log/asterisk/security</span><br><span class="line">maxretry = 3</span><br></pre></td></tr></table></figure><h2 id="Recommended-Configuration"><a href="#Recommended-Configuration" class="headerlink" title="Recommended Configuration:"></a>Recommended Configuration:</h2><p>In <code>/etc/fail2ban/jail.local</code>, it is also recommended to set the configurations below to make your system more secure:</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># "bantime" is the number of seconds that a host is banned.</span></span><br><span class="line"><span class="attr">bantime</span>  = <span class="number">172800</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A host is banned if it has generated "maxretry" during the last "findtime"</span></span><br><span class="line"><span class="comment"># seconds.</span></span><br><span class="line"><span class="attr">findtime</span>  = <span class="number">1200</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># "maxretry" is the number of failures before a host get banned.</span></span><br><span class="line"><span class="attr">maxretry</span> = <span class="number">3</span></span><br></pre></td></tr></table></figure><p><code>bantime</code> is increased to 2 days, <code>findtime</code> increased to 20 minutes, and <code>maxretry</code> is decreased to 3 attempts.</p><h2 id="Verify-that-Fail2ban-is-working"><a href="#Verify-that-Fail2ban-is-working" class="headerlink" title="Verify that Fail2ban is working"></a>Verify that Fail2ban is working</h2><p>First reload fail2ban:</p><figure class="highlight axapta"><table><tr><td class="code"><pre><span class="line">fail2ban-<span class="keyword">client</span> reload</span><br></pre></td></tr></table></figure><p>Check the status of the asterisk filter:</p><figure class="highlight axapta"><table><tr><td class="code"><pre><span class="line">fail2ban-<span class="keyword">client</span> status asterisk</span><br></pre></td></tr></table></figure><p>If you can see a list of blocked IPs then your fail2ban is running and properly detecting brute-force attacks on your Asterisk system!</p><p>It means you have properly secured your Asterisk box.</p><h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><p>If you Asterisk version is different, you may need a different Asterisk filter file for Fail2ban to work properly. </p><p>The best resource for you to find different versions of the Asterisk filter log is Fail2ban’s official Github repository:</p><p><a href="https://github.com/fail2ban/fail2ban" target="_blank" rel="noopener">https://github.com/fail2ban/fail2ban</a></p><p>There you may go to <code>config/filter.d/asterisk.conf</code> and click on history to find all the different versions of that filter file and start testing them with your Asterisk version.</p><p>Usually, if you are using a recent and stable Asterisk and Fail2ban version, the latest file present there should work best with your setup.</p>]]></content>
      
      <categories>
          
          <category> tutorials </category>
          
      </categories>
      
      
        <tags>
            
            <tag> asterisk </tag>
            
            <tag> security </tag>
            
            <tag> voip </tag>
            
        </tags>
      
    </entry>
    
  
  
</search>
